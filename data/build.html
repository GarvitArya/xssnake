<!doctype html>
<meta charset="utf-8">
<title>Build level data</title>

<pre>Check your developer console for output data and instructions.</pre>

<script>
    var start, leveldata, canvas, context, map, image;

    start = +new Date();

    leveldata = [];

    canvas = document.createElement('canvas');
    canvas.width = 64;
    canvas.height = 40;

    context = canvas.getContext('2d');

    map = {
        _0_0_0    : 0, // Wall
        _255_0_0  : 1, // Spawn 1
        _0_255_0  : 2, // Spawn 2
        _0_0_255  : 3, // Spawn 3
        _255_255_0: 4  // Spawn 4
    };

    function loadData(index) {

        image = new Image();
        image.src = './level_images/' + index + '.png';

        // Level image exists
        image.onload = function() {
            var r, g, b, a, imageData, level, mapped;

            level = {
                width : image.width,
                height: image.height,
                player: {},
                wall  : []
            };

            context.drawImage(image, 0, 0);
            imageData = context.getImageData(0, 0, image.width, image.height).data;

            for (var i = 0, m = imageData.length / 4; i < m; ++i) {
                r = imageData[i * 4];
                g = imageData[i * 4 + 1];
                b = imageData[i * 4 + 2];
                a = imageData[i * 4 + 3];

                if (r * g * b * a !== Math.pow(255, 4)) {
                    mapped = map['_' + r + '_' + g + '_' + b];
                    if (typeof mapped === 'undefined') {
                        throw new Error('Uknown pixel color: ' +
                                        [r, g, b, a] + ' in image ' + index);
                    }
                    if (mapped === 0) {
                        level.wall.push(i);
                    } else {
                        level.player[mapped] = i;
                    }

                }
            }

            leveldata.push(level);
            loadData(++index);
        };

        // Level image does not exist, or image is corrupt
        image.onerror = function() {
            var data, output;

            data = leveldata.toSource();
            output = '    var levels = ' + data + ';';

            console.info('Levels:', index);
            console.info('Size:', Math.round(data.length / 10.24) / 100, 'KB');
            console.info('Took:', new Date() - start, 'ms');
            console.info('Replace line 9 of shared/levels.js with:');
            console.log(output);

            document.body.innerHTML += '<pre>'+output+'<br><br></pre>'
        };
    }

    loadData(0);
</script>